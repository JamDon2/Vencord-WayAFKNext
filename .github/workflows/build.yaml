name: Build Vencord
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      release_tag: ${{ steps.check.outputs.release_tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'Vendicated/Vencord'

      - name: Check if already built
        id: check
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "release_tag=$COMMIT_HASH" >> $GITHUB_OUTPUT
          if gh release view "devbuild-$COMMIT_HASH" --repo ${{ github.repository }} &>/dev/null; then
            echo "Release devbuild-$COMMIT_HASH already exists, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.should_build == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'Vendicated/Vencord'

      - name: Clone WayAFKNext plugin
        run: git clone https://github.com/MuffinTastic/WayAFKNext.git src/plugins/userplugins

      - uses: pnpm/action-setup@v3

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: VENCORD_REMOTE="jamdon2/vencord-wayafknext" pnpm buildStandalone

      - name: Clean up obsolete files
        run: |
          rm -rf dist/*-unpacked dist/vendor Vencord.user.css vencordDesktopRenderer.css vencordDesktopRenderer.css.map

      - name: Create new DevBuild release
        run: |
          gh release create "devbuild-$RELEASE_TAG" dist/* \
            --title "DevBuild $RELEASE_TAG" \
            --notes "Built from Vencord commit $RELEASE_TAG" \
            --latest \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.Check.outputs.release_tag }}
