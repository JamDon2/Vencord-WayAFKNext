name: Build Vencord

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      vencord_hash: ${{ steps.check.outputs.vencord_hash }}

    steps:
      - name: Check upstream Vencord
        uses: actions/checkout@v4
        with:
          repository: Vendicated/Vencord

      - name: Compare with latest release
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HASH=$(git rev-parse --short HEAD)
          echo "vencord_hash=$HASH" >> $GITHUB_OUTPUT

          if gh release view "devbuild-$HASH" --repo ${{ github.repository }} &>/dev/null; then
            echo "Already built $HASH, skipping"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  build:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.should_build == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Sync upstream Vencord
        run: |
          # Save our patch files
          cp -r .github /tmp/patch-github
          cp .gitmodules /tmp/patch-gitmodules
          cp README.md /tmp/patch-readme

          # Reset to upstream
          git remote add upstream https://github.com/Vendicated/Vencord.git
          git fetch upstream main
          git reset --hard upstream/main

          # Apply patch
          rm -rf .github
          cp -r /tmp/patch-github .github
          cp /tmp/patch-gitmodules .gitmodules
          cp /tmp/patch-readme README.md

          # Restore and update submodule to latest
          git submodule init
          git submodule update --remote

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A -f
          git commit -m "chore: apply patch" -m "Syncs upstream Vencord, applies workflow/README, adds WayAFKNext plugin"
          git push origin main --force

      - name: Setup pnpm
        uses: pnpm/action-setup@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          VENCORD_HASH: ${{ needs.check.outputs.vencord_hash }}
        run: VENCORD_REMOTE="jamdon2/vencord-wayafknext" pnpm buildStandalone

      - name: Clean artifacts
        run: rm -rf dist/*-unpacked dist/vendor *.css *.css.map

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HASH: ${{ needs.check.outputs.vencord_hash }}
        run: |
          gh release create "devbuild-$HASH" dist/* \
            --repo ${{ github.repository }} \
            --title "DevBuild $HASH" \
            --notes "Built from Vencord commit $HASH with WayAFKNext plugin" \
            --latest
